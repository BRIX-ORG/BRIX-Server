generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum MediaType {
  IMAGE
  GLTF
  VIDEO
}

enum TagType {
  REALTIME
  ART
  PRODUCT
}

enum Role {
  USER
  ADMIN
}

enum Provider {
  LOCAL
  GOOGLE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum NotificationType {
  LIKE_BRICK
  COMMENT_BRICK
  FOLLOW
}

model User {
  id               String   @id @default(uuid()) @db.Uuid
  username         String   @unique
  fullName         String   @map("fullname")
  email            String   @unique
  phone            String?
  password         String
  gender           Gender   @default(OTHER)
  avatar           Json?     @db.JsonB
  background       Json?     @db.JsonB
  address          Json?     @db.JsonB
  shortDescription String?  @map("short_description")
  trustScore       Float    @default(0) @map("trust_score")
  role             Role     @default(USER)
  provider         Provider @default(LOCAL)
  verifiedAt       DateTime? @map("verified_at")
  refreshToken     String?  @map("refresh_token")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  bricks Brick[]

  // Follow relations
  followers  Follow[] @relation("Following")
  following  Follow[] @relation("Follower")

  // Notification relations
  receivedNotifications  NotificationGroup[] @relation("NotificationRecipient")
  lastActorNotifications NotificationGroup[] @relation("NotificationLastActor")
  notificationActors     NotificationActor[] @relation("NotificationActor")

  @@map("users")
}

model Follow {
  followerId  String   @map("follower_id") @db.Uuid
  followingId String   @map("following_id") @db.Uuid
  follower    User     @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")

  @@id([followerId, followingId])
  @@index([followingId], name: "idx_follows_following")
  @@map("follows")
}

model NotificationGroup {
  id          String           @id @default(uuid()) @db.Uuid
  recipientId String           @map("recipient_id") @db.Uuid
  recipient   User             @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  type        NotificationType
  brickId     String?          @map("brick_id") @db.Uuid
  commentId   String?          @map("comment_id") @db.Uuid
  actorsCount Int              @default(1) @map("actors_count")
  lastActorId String           @map("last_actor_id") @db.Uuid
  lastActor   User             @relation("NotificationLastActor", fields: [lastActorId], references: [id], onDelete: Cascade)
  isRead      Boolean          @default(false) @map("is_read")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  actors NotificationActor[]

  @@index([recipientId, type, brickId, commentId, updatedAt], name: "idx_notification_group_aggregate")
  @@index([recipientId, isRead, updatedAt(sort: Desc)], name: "idx_notification_feed")
  @@map("notification_groups")
}

model NotificationActor {
  id                  String            @id @default(uuid()) @db.Uuid
  notificationGroupId String            @map("notification_group_id") @db.Uuid
  notificationGroup   NotificationGroup @relation(fields: [notificationGroupId], references: [id], onDelete: Cascade)
  actorId             String            @map("actor_id") @db.Uuid
  actor               User              @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)
  createdAt           DateTime          @default(now()) @map("created_at")

  @@unique([notificationGroupId, actorId])
  @@map("notification_actors")
}

model Brick {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mediaUrl     String    @map("media_url")
  thumbnailUrl String?   @map("thumbnail_url")
  watermarkUrl String?   @map("watermark_url")
  title        String
  description  String?   @db.Text
  mediaType    MediaType @map("media_type")
  tagType      TagType?  @map("tag_type")
  address      String?
  latitude     Decimal?  @db.Decimal(9, 6)
  longitude    Decimal?  @db.Decimal(9, 6)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  metadata BrickMetadata?

  @@map("bricks")
}

model BrickMetadata {
  id         String    @id @default(uuid()) @db.Uuid
  brickId    String    @unique @map("brick_id") @db.Uuid
  brick      Brick     @relation(fields: [brickId], references: [id], onDelete: Cascade)
  rawExif    Json?     @map("raw_exif")
  modelData  Json?     @map("model_data")
  hashSha256 String?   @map("hash_sha256")
  onChainTx  String?   @map("on_chain_tx")
  verifiedAt DateTime? @map("verified_at")

  @@map("brick_metadata")
}

